===== Config file =====
[force_move]
enable_force_move = True

[respond]
default_type = echo

[gcode_macro G31]
gcode = 
	RUN_SHELL_COMMAND CMD=clear_plr
	SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False

[gcode_shell_command clear_plr]
command = sh /home/mks/clear_plr.sh
timeout = 5.

[gcode_macro save_last_file]
gcode = 
	
	{% set svv = printer.save_variables.variables %}
	
	{% set filepath=printer.virtual_sdcard.file_path %}
	
	{% set filename=filepath.split('/')%}
	
	SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename[-1] }"'
	SAVE_VARIABLE VARIABLE=filepath VALUE='"{ printer.virtual_sdcard.file_path }"'

[gcode_macro clear_last_file]
gcode = 
	{% set filename='' %}
	{% set filepath='' %}
	SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename }"'
	SAVE_VARIABLE VARIABLE=filepath VALUE='"{ filepath }"'

[gcode_shell_command POWER_LOSS_RESUME]
command = /home/mks/plr.sh
timeout = 420.

[gcode_macro RESUME_INTERRUPTED]
gcode = 
	SET_KINEMATIC_POSITION X=0
	SET_KINEMATIC_POSITION Y=0
	SET_KINEMATIC_POSITION Z=0
	{% set z_height = params.Z_HEIGHT|default(printer.save_variables.variables.power_resume_z)|float %}
	{% set last_file = params.GCODE_FILE|default(printer.save_variables.variables.last_file)|string %}
	m118 {last_file}
	
	RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME PARAMS="{z_height} \"{last_file}\""
	SDCARD_PRINT_FILE FILENAME=plr/"{last_file}"

[gcode_macro LOG_Z]
gcode = 
	{% set z_pos = printer.gcode_move.gcode_position.z %}
	RESPOND MSG="Current Z is {z_pos}"
	SAVE_VARIABLE VARIABLE=power_resume_z VALUE={z_pos}

[save_variables]
filename = /home/mks/printer_data/config/saved_variables.cfg

[virtual_sdcard]
path = ~/gcode_files

[stepper_x]
step_pin = PB13
dir_pin = !PB12
enable_pin = !PB14
microsteps = 16
rotation_distance = 40.3
endstop_pin = ^PC0
position_endstop = -9
homing_retract_dist = 0
position_min = -9
position_max = 300
homing_speed = 50

[tmc2209 stepper_x]
uart_pin = PC11
tx_pin = PC10
uart_address = 0
run_current = 0.680
hold_current = 0.500
stealthchop_threshold = 999999

[stepper_y]
step_pin = PB10
dir_pin = !PB2
enable_pin = !PB11
microsteps = 16
rotation_distance = 40
endstop_pin = ^PC1
position_endstop = 0
position_min = 0
position_max = 255
homing_speed = 50

[tmc2209 stepper_y]
uart_pin = PC11
tx_pin = PC10
uart_address = 2
run_current = 0.680
hold_current = 0.500
stealthchop_threshold = 999999

[stepper_z]
step_pin = PB0
dir_pin = PC5
enable_pin = !PB1
microsteps = 16
rotation_distance = 8
endstop_pin = probe:z_virtual_endstop
position_min = -4
position_max = 300

[tmc2209 stepper_z]
uart_pin = PC11
tx_pin = PC10
uart_address = 1
run_current = 0.680
hold_current = 0.500
stealthchop_threshold = 0

[extruder]
step_pin = PB3
dir_pin = PB4
enable_pin = !PD1
microsteps = 16
rotation_distance = 3.502
nozzle_diameter = 0.800
filament_diameter = 1.750
max_extrude_only_distance = 150
max_extrude_cross_section = 5
pressure_advance = 0.012
pressure_advance_smooth_time = 0.040
heater_pin = PC8
sensor_type = ATC Semitec 104NT-4-R025H42G
sensor_pin = PA0
min_temp = -70
max_temp = 300
control = pid
pid_kp = 17.185
pid_ki = 1.081
pid_kd = 68.311

[tmc2209 extruder]
uart_pin = PC11
tx_pin = PC10
uart_address = 3
run_current = 0.85
hold_current = 0.600
stealthchop_threshold = 999999

[heater_bed]
heater_pin = PC9
sensor_type = EPCOS 100K B57560G104F
sensor_pin = PC4
min_temp = -70
max_temp = 130
control = pid
pid_kp = 69.634
pid_ki = 1.563
pid_kd = 775.549

[heater_fan hotend_fan]
pin = PB15
heater = extruder
heater_temp = 50.0

[controller_fan electronic_enclosure_fan]
pin = PC7
heater = heater_bed, extruder
stepper = stepper_x, stepper_y, stepper_z

[fan]
pin = PC6
max_power = 1

[mcu]
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00

[printer]
kinematics = cartesian
max_velocity = 300
max_accel = 3000
max_accel_to_decel = 1000
square_corner_velocity = 5.0
max_z_velocity = 5
max_z_accel = 50

[board_pins]
aliases = 
	
	EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
	EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PD6, EXP1_10=<5V>

[display]
lcd_type = st7920
cs_pin = PB8
sclk_pin = PB9
sid_pin = PD6
encoder_pins = ^PA10, ^PA9
click_pin = ^!PA15

[bltouch]
sensor_pin = ^PC14
control_pin = PA1
probe_with_touch_mode = False
x_offset = -9
y_offset = -25
z_offset = 3.075

[safe_z_home]
home_xy_position = 151,115
speed = 250
z_hop = 10
z_hop_speed = 5

[bed_mesh]
speed = 200
horizontal_move_z = 10
mesh_min = 20,20
mesh_max = 280, 220
probe_count = 12,12
mesh_pps = 10,10
algorithm = bicubic
bicubic_tension = 0.05
fade_start = .01
fade_end = 10

[bed_screws]
screw1 = 45,45
screw1_name = Front Left Screw
screw2 = 255,45
screw2_name = Front Right Screw
screw3 = 255,210
screw3_name = Rear Right Screw
screw4 = 45,210
screw4_name = Rear Left Screw
screw5 = 151,115
screw5_name = Center

[screws_tilt_adjust]
screw1 = 50,60
screw1_name = Front left screw
screw2 = 265,60
screw2_name = Front right screw
screw3 = 265,245
screw3_name = Rear right screw
screw4 = 50, 245
screw4_name = Rear left screw
screw5 = 140,127.5
screw5_name = Center screw
horizontal_move_z = 10
speed = 250.
screw_thread = CCW-M4

[display_status]

[pause_resume]

[input_shaper]
shaper_freq_x = 51.2
shaper_type_x = mzv
shaper_freq_y = 39.6
shaper_type_y = mzv

[gcode_arcs]

[temperature_sensor raspberry_pi]
sensor_type = temperature_host
max_temp = 100

[temperature_sensor mcu_temp]
sensor_type = temperature_mcu
max_temp = 100

[idle_timeout]
timeout = 9999999

[output_pin caselight]
pin = PA8
pwm = False
value = 0

[exclude_object]

[bed_mesh default]
version = 1
points = 
	-0.002500, 0.020000, -0.017500, -0.072500, -0.082500
	0.060000, 0.045000, 0.012500, 0.025000, -0.070000
	0.062500, 0.067500, 0.062500, 0.037500, -0.057500
	0.097500, 0.082500, 0.055000, 0.032500, -0.067500
tension = 0.05
min_x = 107.69
algo = lagrange
y_count = 4
mesh_y_pps = 10
min_y = 101.76
x_count = 5
max_y = 139.05
mesh_x_pps = 10
max_x = 191.77
=======================
Args: ['/home/mks/klipper/klippy/klippy.py', '/home/mks/printer_data/config/printer.cfg', '-I', '/home/mks/printer_data/comms/klippy.serial', '-l', '/home/mks/printer_data/logs/klippy.log', '-a', '/home/mks/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-122-ge6ef48cd'
CPU: 4 core ?
Python: '3.7.3 (default, Oct 31 2022, 14:04:00) \n[GCC 8.3.0]'
webhooks client 281472817665192: {'program': 'Moonraker', 'version': 'v0.8.0-23-g18f5ff4-dirty'}
=============== Log rollover at Fri Nov  3 22:36:13 2023 ===============
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_1500370015504B5735313920-if00'
MCU error during connect
Traceback (most recent call last):
  File "/home/mks/klipper/klippy/mcu.py", line 798, in _mcu_identify
    self._serial.connect_uart(self._serialport, self._baud, rts)
  File "/home/mks/klipper/klippy/serialhdl.py", line 182, in connect_uart
    self._error("Unable to connect")
  File "/home/mks/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/mks/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/mks/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/mks/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/mks/klipper/klippy/mcu.py", line 803, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
Build file /home/mks/klipper/klippy/../.config(3223): Sun Mar  5 05:11:05 2023
========= Last MCU build config =========
CONFIG_LOW_LEVEL_OPTIONS=y
# CONFIG_MACH_AVR is not set
# CONFIG_MACH_ATSAM is not set
# CONFIG_MACH_ATSAMD is not set
# CONFIG_MACH_LPC176X is not set
CONFIG_MACH_STM32=y
# CONFIG_MACH_HC32F460 is not set
# CONFIG_MACH_RP2040 is not set
# CONFIG_MACH_PRU is not set
# CONFIG_MACH_AR100 is not set
# CONFIG_MACH_LINUX is not set
# CONFIG_MACH_SIMU is not set
CONFIG_BOARD_DIRECTORY="stm32"
CONFIG_MCU="stm32f407xx"
CONFIG_CLOCK_FREQ=168000000
CONFIG_USBSERIAL=y
CONFIG_FLASH_SIZE=0x80000
CONFIG_FLASH_BOOT_ADDRESS=0x8000000
CONFIG_RAM_START=0x20000000
CONFIG_RAM_SIZE=0x20000
CONFIG_STACK_SIZE=512
CONFIG_FLASH_APPLICATION_ADDRESS=0x800C000
CONFIG_STM32_SELECT=y
# CONFIG_MACH_STM32F103 is not set
# CONFIG_MACH_STM32F207 is not set
# CONFIG_MACH_STM32F401 is not set
# CONFIG_MACH_STM32F405 is not set
CONFIG_MACH_STM32F407=y
# CONFIG_MACH_STM32F429 is not set
# CONFIG_MACH_STM32F446 is not set
# CONFIG_MACH_STM32F031 is not set
# CONFIG_MACH_STM32F042 is not set
# CONFIG_MACH_STM32F070 is not set
# CONFIG_MACH_STM32F072 is not set
# CONFIG_MACH_STM32G070 is not set
# CONFIG_MACH_STM32G071 is not set
# CONFIG_MACH_STM32G0B0 is not set
# CONFIG_MACH_STM32G0B1 is not set
# CONFIG_MACH_STM32G431 is not set
# CONFIG_MACH_STM32H723 is not set
# CONFIG_MACH_STM32H743 is not set
# CONFIG_MACH_STM32H750 is not set
# CONFIG_MACH_STM32L412 is not set
CONFIG_MACH_STM32F4=y
CONFIG_MACH_STM32F4x5=y
CONFIG_HAVE_STM32_USBOTG=y
CONFIG_HAVE_STM32_CANBUS=y
CONFIG_HAVE_STM32_USBCANBUS=y
CONFIG_STM32_DFU_ROM_ADDRESS=0x1fff0000
# CONFIG_STM32_FLASH_START_8000 is not set
# CONFIG_STM32_FLASH_START_20200 is not set
CONFIG_STM32_FLASH_START_C000=y
# CONFIG_STM32_FLASH_START_4000 is not set
# CONFIG_STM32_FLASH_START_0000 is not set
CONFIG_STM32_CLOCK_REF_8M=y
# CONFIG_STM32_CLOCK_REF_12M is not set
# CONFIG_STM32_CLOCK_REF_16M is not set
# CONFIG_STM32_CLOCK_REF_20M is not set
# CONFIG_STM32_CLOCK_REF_25M is not set
# CONFIG_STM32_CLOCK_REF_INTERNAL is not set
CONFIG_CLOCK_REF_FREQ=8000000
CONFIG_STM32F0_TRIM=16
CONFIG_STM32_USB_PA11_PA12=y
# CONFIG_STM32_SERIAL_USART1 is not set
# CONFIG_STM32_SERIAL_USART1_ALT_PB7_PB6 is not set
# CONFIG_STM32_SERIAL_USART2 is not set
# CONFIG_STM32_SERIAL_USART2_ALT_PD6_PD5 is not set
# CONFIG_STM32_SERIAL_USART3 is not set
# CONFIG_STM32_SERIAL_USART3_ALT_PD9_PD8 is not set
# CONFIG_STM32_CANBUS_PA11_PA12 is not set
# CONFIG_STM32_CANBUS_PA11_PB9 is not set
# CONFIG_STM32_MMENU_CANBUS_PB8_PB9 is not set
# CONFIG_STM32_MMENU_CANBUS_PI9_PH13 is not set
# CONFIG_STM32_MMENU_CANBUS_PB5_PB6 is not set
# CONFIG_STM32_MMENU_CANBUS_PB12_PB13 is not set
# CONFIG_STM32_MMENU_CANBUS_PD0_PD1 is not set
# CONFIG_STM32_USBCANBUS_PA11_PA12 is not set
CONFIG_USB=y
CONFIG_USB_VENDOR_ID=0x1d50
CONFIG_USB_DEVICE_ID=0x614e
CONFIG_USB_SERIAL_NUMBER_CHIPID=y
CONFIG_USB_SERIAL_NUMBER="12345"

#
# USB ids
#
# end of USB ids

CONFIG_CANBUS_FREQUENCY=500000
CONFIG_INITIAL_PINS=""
CONFIG_HAVE_GPIO=y
CONFIG_HAVE_GPIO_ADC=y
CONFIG_HAVE_GPIO_SPI=y
CONFIG_HAVE_GPIO_SDIO=y
CONFIG_HAVE_GPIO_I2C=y
CONFIG_HAVE_GPIO_HARD_PWM=y
CONFIG_HAVE_GPIO_BITBANGING=y
CONFIG_HAVE_STRICT_TIMING=y
CONFIG_HAVE_CHIPID=y
CONFIG_HAVE_STEPPER_BOTH_EDGE=y
CONFIG_HAVE_BOOTLOADER_REQUEST=y
CONFIG_INLINE_STEPPER_HACK=y
=======================
Build file /home/mks/klipper/klippy/../out/klipper.dict(8495): Sun Mar  5 05:11:35 2023
Last MCU build version: ?-20230305_171135-mkspi
Last MCU build tools: gcc: (15:7-2018-q2-6) 7.3.1 20180622 (release) [ARM/embedded-7-branch revision 261907] binutils: (2.31.1-12+11) 2.31.1
Last MCU build config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_sdio=PC12,PD2,PC8,PC9,PC10,PC11 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi2b=PI2,PI3,PI1 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 CLOCK_FREQ=168000000 MCU=stm32f407xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
Build file /home/mks/klipper/klippy/../out/klipper.elf(377440): Sun Mar  5 05:11:46 2023
